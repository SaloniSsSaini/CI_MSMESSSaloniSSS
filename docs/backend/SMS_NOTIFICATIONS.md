# SMS Notifications Service

The backend now supports outbound SMS notifications for MSMEs using the MSG91 platform. These notifications keep MSMEs informed about milestones, carbon scores, recommendations, incentives, and real-time carbon alerts generated by the AI monitoring services.

## Configuration

Set the following environment variables in the backend service:

- `MSG91_AUTH_KEY` – Your MSG91 Authkey (required)
- `MSG91_SENDER_ID` – Approved sender ID (required)
- `MSG91_ROUTE` – MSG91 route (defaults to `4` for transactional)
- `MSG91_API_BASE_URL` – Optional custom API base (defaults to `https://control.msg91.com/api`)
- `MSG91_API_VERSION` – Optional API version (defaults to `v5`)
- `MSG91_COUNTRY_CODE` – Optional country code prefix (defaults to `91`)
- `MSG91_UNICODE` – Set to `1` to send Unicode messages (default `0`)
- `MSG91_SHORT_URL` – Set to `true` to enable MSG91 URL shortening

Make sure the backend container/service has outbound access to MSG91 APIs and that the sender ID and templates (if used) are DLT-approved.

## Usage

### API Endpoint

`POST /api/sms/notify`

Send a notification on behalf of the authenticated user or, for admin/service roles, on behalf of a specific MSME.

Request body:

```json
{
  "type": "progress",
  "data": {
    "milestone": "Energy audit",
    "status": "completed",
    "eta": "2025-11-30",
    "nextSteps": ["Upload reports"],
    "notes": "Great work team!"
  },
  "msmeId": "<optional-mongo-id>"
}
```

Supported `type` values:

- `progress`
- `carbon_score`
- `recommendations`
- `incentives`
- `carbon_footprint`
- `alert`
- `custom`

MSME users automatically target their own MSME profile. Admin and service accounts can specify an `msmeId` to target another MSME.

### Automated Alerts

The real-time carbon monitoring service now dispatches SMS alerts through MSG91 whenever threshold breaches occur. Alerts include the affected metric, severity, current value, and recommended action.

## Testing

Unit tests cover the MSG91 client wrapper and the MSME notification service. Run the backend test suite to verify the integration:

```bash
npm test --prefix backend
```

The MSG91 client is mocked, so tests do not send real SMS traffic.
